<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DataBridge API Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f9fa;
      color: #222;
    }
    .container {
      max-width: 700px;
      margin: 2rem auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.07);
      padding: 2rem;
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 1rem;
      text-align: center;
    }
    label {
      font-weight: bold;
      margin-top: 1rem;
      display: block;
    }
    input, select {
      width: 100%;
      padding: 0.5rem;
      margin: 0.3rem 0 1rem 0;
      border: 1px solid #ccc;
      border-radius: 4px;
      font-size: 1rem;
    }
    .row {
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .row > div {
      flex: 1 1 200px;
    }
    button {
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      padding: 0.7rem 1.2rem;
      font-size: 1rem;
      cursor: pointer;
      margin-right: 0.5rem;
    }
    button:disabled {
      background: #aaa;
      cursor: not-allowed;
    }
    .results, .filtered, .light {
      background: #f1f3f4;
      border-radius: 6px;
      padding: 1rem;
      margin-top: 1rem;
      font-size: 0.97rem;
      overflow-x: auto;
      white-space: pre-wrap;
    }
    .fields {
      margin: 1rem 0;
    }
    @media (max-width: 600px) {
      .container { padding: 1rem; }
      .row { flex-direction: column; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>DataBridge API Viewer</h1>
    <!-- Formulaire principal -->
    <form id="apiForm" autocomplete="off">
      <label for="fullUrl">URL complète de l'API JSON</label>
      <input type="url" id="fullUrl" placeholder="https://..." />
      <div style="text-align:center; margin:0.5rem 0;">OU</div>
      <div class="row">
        <div>
          <label for="gid">gid</label>
          <input type="number" id="gid" placeholder="Ex: 2447" />
        </div>
        <div>
          <label for="key">key</label>
          <input type="text" id="key" placeholder="Ex: 610F7N264Q" />
        </div>
        <div>
          <label for="crs">crs</label>
          <input type="text" id="crs" placeholder="Ex: epsg:4326" />
        </div>
      </div>
      <label for="refreshInterval">Rafraîchissement auto (sec)</label>
      <input type="number" id="refreshInterval" min="0" value="0" />
      <button type="button" id="fetchBtn">Récupérer</button>
      <button type="button" id="refreshBtn">Rafraîchir</button>
    </form>
    <!-- Section champs dynamiques -->
    <div class="fields" id="fieldsContainer"></div>
    <!-- Résultats JSON brut -->
    <label>Résultats JSON</label>
    <div class="results" id="results"></div>
    <!-- Résultats filtrés -->
    <label>Données filtrées</label>
    <div class="filtered" id="filtered"></div>
    <!-- JSON allégé pour ESP32 -->
    <label>JSON allégé (ESP32)</label>
    <div class="light" id="light"></div>
curl -s -G "https://data.bordeaux-metropole.fr/geojson/features/pc_captv_p" \
  --data-urlencode "crs=epsg:4326" \
  --data-urlencode "filter={\"gid\": 2447}" \
  --data-urlencode "key=610F7N264Q"
  </div>
  <script>
    // --- Variables globales ---
    let jsonData = null;
    let autoRefreshTimer = null;

    // --- Construction de l'URL à partir des paramètres ---
    function buildUrl() {
      const fullUrl = document.getElementById('fullUrl').value.trim();
      if (fullUrl) return fullUrl;
      // Paramètres séparés
      const gid = document.getElementById('gid').value.trim();
      const key = document.getElementById('key').value.trim();
      const crs = document.getElementById('crs').value.trim();
      if (!gid || !key || !crs) return '';
      // Exemple d'API Bordeaux
      const base = 'https://data.bordeaux-metropole.fr/geojson/features/pc_captv_p';
      const params = new URLSearchParams();
      params.append('crs', crs);
      params.append('filter', JSON.stringify({ gid: Number(gid) }));
      params.append('key', key);
      return `${base}?${params.toString()}`;
    }

    // --- Fetch des données JSON ---
    async function fetchData() {
      let url = buildUrl();
      if (!url) {
        alert('Veuillez saisir une URL complète ou tous les paramètres.');
        return;
      }
      // Ajout proxy CORS si nécessaire
      try {
        const pageOrigin = window.location.origin;
        const urlObj = new URL(url);
        if (urlObj.origin !== pageOrigin) {
          url = 'https://corsproxy.io/?' + url;
        }
      } catch (e) {}
      document.getElementById('fetchBtn').disabled = true;
      try {
        const res = await fetch(url);
        if (!res.ok) throw new Error('Erreur HTTP ' + res.status);
        jsonData = await res.json();
        showResults();
        buildFields();
        filterData();
      } catch (e) {
        document.getElementById('results').textContent = 'Erreur: ' + e.message;
        document.getElementById('filtered').textContent = '';
        document.getElementById('light').textContent = '';
      } finally {
        document.getElementById('fetchBtn').disabled = false;
      }
    }

    // --- Affichage JSON brut ---
    function showResults() {
      document.getElementById('results').textContent = JSON.stringify(jsonData, null, 2);
    }

    // --- Construction dynamique des champs à filtrer ---
    function buildFields() {
      const container = document.getElementById('fieldsContainer');
      container.innerHTML = '';
      if (!jsonData) return;
      // Fonction récursive pour générer l'arborescence des champs
      function createTree(obj, path = []) {
        if (typeof obj !== 'object' || obj === null) return;
        const ul = document.createElement('ul');
        ul.style.listStyle = 'none';
        ul.style.marginLeft = '1em';
        Object.keys(obj).forEach(key => {
          const li = document.createElement('li');
          const id = 'field_' + [...path, key].join('__');
          li.innerHTML = `<label style="font-weight:normal;"><input type="checkbox" id="${id}" /> ${key}</label>`;
          // Ajout récursif si sous-objet
          if (typeof obj[key] === 'object' && obj[key] !== null && !Array.isArray(obj[key])) {
            li.appendChild(createTree(obj[key], [...path, key]));
          }
          ul.appendChild(li);
        });
        return ul;
      }
      // Détection du premier objet à explorer
      let firstObj = null;
      if (Array.isArray(jsonData) && jsonData.length) {
        firstObj = jsonData[0];
      } else if (typeof jsonData === 'object' && jsonData !== null) {
        const arrKey = Object.keys(jsonData).find(k => Array.isArray(jsonData[k]) && jsonData[k].length && typeof jsonData[k][0] === 'object');
        if (arrKey) {
          firstObj = jsonData[arrKey][0];
        } else {
          firstObj = jsonData;
        }
      }
      if (!firstObj || typeof firstObj !== 'object') return;
      container.appendChild(createTree(firstObj));
      // Ajout des listeners
      container.querySelectorAll('input[type=checkbox]').forEach(cb => {
        cb.addEventListener('change', filterData);
      });
    }

    // --- Filtrage des données selon les champs sélectionnés ---
    function filterData() {
      if (!jsonData) return;
      // Récupère les chemins cochés
      const container = document.getElementById('fieldsContainer');
      const checked = Array.from(container.querySelectorAll('input[type=checkbox]:checked'));
      const paths = checked.map(cb => cb.id.replace('field_', '').split('__'));
      // Fonction pour extraire la valeur selon le chemin
      function extract(obj, path) {
        let val = obj;
        for (const p of path) {
          if (val && typeof val === 'object' && p in val) {
            val = val[p];
          } else {
            return undefined;
          }
        }
        return val;
      }
      // Fonction pour construire l'arborescence filtrée
      function buildTree(obj, paths) {
        const tree = {};
        paths.forEach(path => {
          let ref = tree;
          let val = obj;
          for (let i = 0; i < path.length; i++) {
            const p = path[i];
            if (i === path.length - 1) {
              ref[p] = extract(obj, path);
            } else {
              ref[p] = ref[p] || {};
              ref = ref[p];
              val = val && val[p];
            }
          }
        });
        return tree;
      }
      let filtered = [];
      if (Array.isArray(jsonData)) {
        filtered = jsonData.map(obj => buildTree(obj, paths));
      } else if (typeof jsonData === 'object' && jsonData !== null) {
        const arrKey = Object.keys(jsonData).find(k => Array.isArray(jsonData[k]) && jsonData[k].length && typeof jsonData[k][0] === 'object');
        if (arrKey) {
          filtered = jsonData[arrKey].map(obj => buildTree(obj, paths));
        } else {
          filtered = [buildTree(jsonData, paths)];
        }
      }
      // Affichage arborescent
      function renderTree(obj, indent = 0) {
        if (typeof obj !== 'object' || obj === null) return JSON.stringify(obj);
        let html = '';
        for (const k in obj) {
          if (typeof obj[k] === 'object' && obj[k] !== null) {
            html += ' '.repeat(indent) + k + ':\n' + renderTree(obj[k], indent + 2);
          } else {
            html += ' '.repeat(indent) + k + ': ' + obj[k] + '\n';
          }
        }
        return html;
      }
      document.getElementById('filtered').textContent = filtered.map(f => renderTree(f)).join('\n---\n');
      // Génération JSON allégé pour ESP32
      document.getElementById('light').textContent = JSON.stringify(filtered, null, 0);
    }

    // --- Rafraîchissement manuel ---
    document.getElementById('fetchBtn').onclick = fetchData;
    document.getElementById('refreshBtn').onclick = fetchData;

    // --- Rafraîchissement automatique ---
    document.getElementById('refreshInterval').onchange = function() {
      const val = Number(this.value);
      if (autoRefreshTimer) clearInterval(autoRefreshTimer);
      if (val > 0) {
        autoRefreshTimer = setInterval(fetchData, val * 1000);
      }
    };

    // --- Commentaires pour maintenance ---
    // - buildUrl() : génère l'URL selon saisie utilisateur
    // - fetchData() : récupère et affiche le JSON
    // - buildFields() : génère dynamiquement les cases à cocher
    // - filterData() : filtre et affiche les données selon sélection
    // - Rafraîchissement manuel/auto : boutons et intervalle
    // - Interface responsive et minimaliste
  </script>
</body>
</html>
