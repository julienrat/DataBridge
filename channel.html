<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DataBridge Channel Viewer</title>
    <style>
        body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif; margin: 0; padding: 20px; background: #f3f4f6; }
        .wrap { max-width: 1200px; margin: 0 auto; }
        h1 { margin: 0 0 10px 0; }
        .bar { display: grid; grid-template-columns: 1.2fr 1fr auto; gap: 10px; margin: 15px 0; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: white; border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; }
        label { font-weight: 600; font-size: 13px; display: block; margin-bottom: 6px; color: #374151; }
        input, select, textarea { width: 100%; box-sizing: border-box; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
        textarea { min-height: 80px; }
        .btn { padding: 10px 14px; border-radius: 8px; border: 1px solid #2563eb; background: #2563eb; color: white; cursor: pointer; font-weight: 600; }
        .btn.secondary { background: white; color: #2563eb; }
        .status { margin: 10px 0; padding: 8px 12px; border-radius: 8px; font-weight: 600; }
        .status.ok { background: #ecfdf5; color: #065f46; border: 1px solid #a7f3d0; }
        .status.err { background: #fef2f2; color: #991b1b; border: 1px solid #fecaca; }
        pre { margin: 0; white-space: pre-wrap; word-break: break-word; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; background: #0b1220; color: #e5e7eb; border-radius: 8px; padding: 12px; max-height: 400px; overflow: auto; }
        .flex { display: flex; gap: 10px; align-items: center; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .tree { max-height: 400px; overflow: auto; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px; }
        .tree .item { display: flex; align-items: center; gap: 6px; padding: 4px 6px; border-radius: 6px; }
        .tree .item:hover { background: #f9fafb; }
        .muted { color: #6b7280; font-size: 12px; }
    </style>
</head>
<body>
    <div class="wrap">
        <h1>DataBridge Channel Viewer <span id="version" class="muted">v0.3.0</span></h1>

        <div class="card">
            <div class="bar">
                <div>
                    <label>Fichier de configuration (.cfg) GitHub</label>
                    <input id="cfgUrl" placeholder="https://raw.githubusercontent.com/<user>/<repo>/main/channel1.cfg">
                </div>
                <div>
                    <label>Canal rapide</label>
                    <select id="quickChannel">
                        <option value="">Aucun</option>
                        <option value="channel1.cfg">channel1</option>
                        <option value="channel2.cfg">channel2</option>
                    </select>
                </div>
                <div class="flex" style="align-self:end;">
                    <button class="btn" onclick="loadCfg()">Charger config</button>
                </div>
            </div>

            <div class="row">
                <div class="card">
                    <label>Request URL complète</label>
                    <input id="requestUrl" placeholder="https://example.com/api?param=value">
                </div>
                <div class="card">
                    <label>Générateur de paramètres (clé=valeur, un par ligne)</label>
                    <textarea id="paramsInput" placeholder="key1=value1\nkey2=value2"></textarea>
                    <div class="flex" style="margin-top:8px;">
                        <button class="btn secondary" onclick="buildUrl()">Construire l'URL</button>
                        <button class="btn secondary" onclick="clearParams()">Effacer</button>
                    </div>
                </div>
            </div>

            <div class="row" style="margin-top:10px;">
                <div class="card">
                    <div class="flex" style="justify-content: space-between;">
                        <div class="flex" style="gap:8px;">
                            <button class="btn" onclick="doFetch()">Fetch</button>
                            <div class="flex">
                                <label style="margin:0 8px 0 0;">Auto refresh (s)</label>
                                <input id="interval" type="number" value="0" min="0" style="width:100px;">
                                <button class="btn secondary" style="margin-left:8px;" onclick="toggleAuto()" id="autoBtn">Démarrer</button>
                            </div>
                        </div>
                        <div class="muted" id="status"></div>
                    </div>
                </div>
                <div class="card">
                    <label>Afficher uniquement ces clés (séparées par des virgules)</label>
                    <input id="keysFilter" placeholder="path.to.key1,path.to.key2">
                    <div class="muted">Ou cochez dans l'arbre ci-dessous</div>
                </div>
            </div>
        </div>

        <div class="grid" style="margin-top:10px;">
            <div class="card">
                <h3 style="margin:0 0 8px 0;">JSON brut</h3>
                <pre id="raw"></pre>
            </div>
            <div class="card">
                <h3 style="margin:0 0 8px 0;">Vue arbre & sélection</h3>
                <div id="tree" class="tree"></div>
            </div>
        </div>

        <div class="card" style="margin-top:10px;">
            <h3 style="margin:0 0 8px 0;">Résultats sélectionnés</h3>
            <pre id="selected"></pre>
        </div>
    </div>

    <script>
        let data = null;
        let autoTimer = null;

        function setStatus(msg, ok=true){
            const s = document.getElementById('status');
            s.textContent = msg || '';
            s.className = ok ? 'muted' : 'muted';
        }

        async function loadCfg(){
            try {
                const quick = document.getElementById('quickChannel').value;
                const url = quick ? new URL(quick, window.location).href : document.getElementById('cfgUrl').value.trim();
                if(!url){ setStatus('Aucune URL de configuration', false); return; }
                const text = await fetch(url).then(r=>{ if(!r.ok) throw new Error(r.status); return r.text(); });
                const defaultUrl = parseCfg(text);
                if(defaultUrl){
                    document.getElementById('requestUrl').value = defaultUrl;
                    setStatus('Configuration chargée');
                } else {
                    setStatus('Configuration vide ou invalide', false);
                }
            } catch(e){ setStatus('Erreur config: '+e.message, false); }
        }

        function parseCfg(text){
            // Format simple: lignes key=value, on cherche DEFAULT_URL=...
            const lines = text.split(/\r?\n/);
            for(const l of lines){
                const m = l.match(/^\s*DEFAULT_URL\s*=\s*(.+)\s*$/);
                if(m) return m[1];
            }
            return '';
        }

        function buildUrl(){
            const base = document.getElementById('requestUrl').value.trim();
            const params = document.getElementById('paramsInput').value.trim();
            if(!base){ setStatus('URL base vide', false); return; }
            const u = new URL(base);
            if(params){
                params.split(/\r?\n/).forEach(line=>{
                    if(!line) return;
                    const idx = line.indexOf('=');
                    if(idx === -1){ u.searchParams.append(line, ''); return; }
                    const k = line.slice(0, idx).trim();
                    const v = line.slice(idx+1).trim();
                    u.searchParams.append(k, v);
                });
            }
            document.getElementById('requestUrl').value = u.toString();
            setStatus('URL construite');
        }

        function clearParams(){
            document.getElementById('paramsInput').value = '';
        }

        async function doFetch(){
            const url = document.getElementById('requestUrl').value.trim();
            if(!url){ setStatus('URL vide', false); return; }
            try{
                setStatus('Chargement...');
                const res = await fetch(url);
                if(!res.ok) throw new Error(res.status+'');
                const ct = res.headers.get('content-type')||'';
                if(!ct.includes('application/json')){
                    const txt = await res.text();
                    document.getElementById('raw').textContent = txt;
                    data = null;
                    renderTree(null);
                    renderSelected();
                    setStatus('Réponse non JSON', false);
                    return;
                }
                data = await res.json();
                document.getElementById('raw').textContent = JSON.stringify(data, null, 2);
                renderTree(data);
                renderSelected();
                setStatus('OK');
            }catch(e){ setStatus('Erreur fetch: '+e.message, false); }
        }

        function renderTree(obj){
            const container = document.getElementById('tree');
            container.innerHTML = '';
            if(!obj){ return; }
            const root = document.createElement('div');
            buildTree(root, obj, '');
            container.appendChild(root);
        }

        function buildTree(container, obj, path){
            if(Array.isArray(obj)){
                obj.forEach((item, idx)=>{
                    const p = path ? path+`[${idx}]` : `[${idx}]`;
                    buildTree(container, item, p);
                });
                return;
            }
            if(obj && typeof obj === 'object'){
                Object.keys(obj).forEach(key=>{
                    const p = path ? path + '.' + key : key;
                    const val = obj[key];
                    if(val && typeof val === 'object'){
                        const row = document.createElement('div');
                        row.className = 'item';
                        row.innerHTML = `<input type="checkbox" class="k" value="${p}"><strong>${p}</strong>`;
                        container.appendChild(row);
                        buildTree(container, val, p);
                    } else {
                        const row = document.createElement('div');
                        row.className = 'item';
                        row.innerHTML = `<input type="checkbox" class="k" value="${p}"><span>${p}</span> <span class="muted">= ${formatScalar(val)}</span>`;
                        container.appendChild(row);
                    }
                });
                return;
            }
            // scalar at root
            const row = document.createElement('div');
            row.className = 'item';
            row.innerHTML = `<input type="checkbox" class="k" value="${path}"><span>${path||'(root)'}</span> <span class="muted">= ${formatScalar(obj)}</span>`;
            container.appendChild(row);
        }

        function formatScalar(v){
            if(typeof v === 'string') return JSON.stringify(v);
            if(typeof v === 'number' || typeof v === 'boolean') return String(v);
            if(v == null) return 'null';
            return typeof v;
        }

        function getSelectedKeys(){
            const input = document.getElementById('keysFilter').value.trim();
            const set = new Set();
            if(input){ input.split(',').map(s=>s.trim()).filter(Boolean).forEach(k=>set.add(k)); }
            document.querySelectorAll('#tree .k:checked').forEach(cb=> set.add(cb.value));
            return Array.from(set);
        }

        function renderSelected(){
            const keys = getSelectedKeys();
            if(!data || keys.length===0){ document.getElementById('selected').textContent = ''; return; }
            const out = {};
            keys.forEach(k=>{
                const v = getByPath(data, k);
                if(v !== undefined) setByPath(out, k, v);
            });
            document.getElementById('selected').textContent = JSON.stringify(out, null, 2);
        }

        function getByPath(obj, path){
            if(!path) return obj;
            const parts = path.split(/[\.\[\]]+/).filter(Boolean);
            return parts.reduce((cur, p)=>{
                if(cur==null) return undefined;
                const idx = Number.isInteger(+p) ? +p : NaN;
                if(!Number.isNaN(idx)) return cur[idx];
                return cur[p];
            }, obj);
        }

        function setByPath(obj, path, value){
            if(!path){ return; }
            const parts = path.split(/[\.\[\]]+/).filter(Boolean);
            const last = parts.pop();
            let cur = obj;
            for(const p of parts){
                const idx = Number.isInteger(+p) ? +p : NaN;
                if(Number.isNaN(idx)){
                    if(!(p in cur)) cur[p] = {};
                    cur = cur[p];
                } else {
                    if(!Array.isArray(cur)) cur = (cur[p]=[]);
                    if(!cur[idx]) cur[idx] = {};
                    cur = cur[idx];
                }
            }
            const idx = Number.isInteger(+last) ? +last : NaN;
            if(Number.isNaN(idx)) cur[last] = value; else cur[idx] = value;
        }

        function toggleAuto(){
            const btn = document.getElementById('autoBtn');
            const n = parseInt(document.getElementById('interval').value, 10) || 0;
            if(autoTimer){
                clearInterval(autoTimer); autoTimer=null; btn.textContent='Démarrer'; setStatus('Auto off'); return;
            }
            if(n<=0){ setStatus('Intervalle invalide', false); return; }
            autoTimer = setInterval(()=>{ doFetch().then(()=>renderSelected()); }, n*1000);
            btn.textContent='Arrêter'; setStatus('Auto on');
        }

        // Update results when keys selection changes
        document.addEventListener('change', (e)=>{
            if(e.target && e.target.classList && e.target.classList.contains('k')){
                renderSelected();
            }
        });
        document.getElementById('keysFilter').addEventListener('input', ()=> renderSelected());

        // If page loaded with ?cfg=... param
        (function init(){
            const p = new URLSearchParams(location.search);
            const cfg = p.get('cfg');
            const url = p.get('url');
            if(cfg){ document.getElementById('cfgUrl').value = cfg; loadCfg(); }
            if(url){ document.getElementById('requestUrl').value = url; }
        })();
    </script>
</body>
</html>


